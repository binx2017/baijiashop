<extend name="Common/home"/>

<block name="container">

    <div class="container">
        <ul class="breadcrumb">
            <li><a href="{:U('/index')}"><i class="fa fa-home"></i></a></li>
            <li><a href="{:U('/cart')}">购物车</a></li>
            <li><a href="{:U('/checkout')}">结账</a></li>
        </ul>
        <div class="row">
            <div id="content" class="col-sm-12">
                <h1>结账</h1>
                <div class="panel-group" id="accordion">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a class="accordion-toggle collapsed" data-parent="#accordion" data-toggle="collapse"
                                   href="#collapse-shipping-address" aria-expanded="false">第 1 步 货运地址 <i
                                        class="fa fa-caret-down"></i></a>
                            </h4>
                        </div>
                        <!-- <div class="panel-collapse collapse" id="collapse-shipping-address"> -->
                        <div id="collapse-shipping-address" class="panel-collapse collapse in" aria-expanded="true"
                             style="">
                            <div class="panel-body">
                                <div class="radio">
                                    <label>
                                        <input type="radio" value="existing" name="shipping_address"
                                               id="input-address-existing">
                                        使用现存地址</label>
                                </div>
                                <div id="shipping-existing" style="display: block;">
                                    <select class="form-control" id="select-address_id" name="address_id"
                                            data-url="{:U('/addressList')}">
                                    </select>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" value="new" name="shipping_address" id="input-address-new">添加一个新地址</label>
                                </div>
                                <br>
                                <form action="{:U('/addressAdd')}" method="post" class="form-horizontal" id="form-address-add">
                                    <div style="" id="shipping-new">

                                        <div class="form-group required">
                                            <label for="input-name"
                                                   class="col-sm-2 control-label">您的姓名</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="input-name" placeholder="您的姓名" value="" name="name">
                                            </div>
                                        </div>
                                        <div data-sort="1" class="form-group required custom-field">
                                            <label for="input-telephone"
                                                   class="col-sm-2 control-label">手机号码</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control"
                                                       id="input-telephone" placeholder="手机号码" value="" name="telephone">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="input-company"
                                                   class="col-sm-2 control-label">公司名称</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="input-company" placeholder="公司名称" value="" name="company">
                                            </div>
                                        </div>
                                        <div class="form-group required" id="container-region-select" data-url="{:U('/regionList')}">
                                            <label for="input-region_one_id"
                                                   class="col-sm-2 control-label">省/直辖市</label>
                                            <div class="col-sm-2">
                                                <select class="form-control" id="input-region_one_id" name="region_one_id" level="1">
                                                    <option value="0"> --- 请选择 ---</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <select class="form-control" id="input-region_two_id" name="region_two_id" level="2">
                                                    <option value="0"> --- 请选择 ---</option>
                                                </select>
                                            </div>

                                            <div class="col-sm-2">
                                                <select class="form-control" id="input-region_three_id" name="region_three_id" level="3">
                                                    <option value="0"> --- 请选择 ---</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-4">
                                                <input type="text" class="form-control" id="input-address" placeholder="地址" value="" name="address">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="input-postcode"
                                                   class="col-sm-2 control-label">邮编</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="input-postcode" placeholder="邮编" value="" name="postcode">
                                            </div>
                                        </div>

                                    </div>
                                    <div class="buttons clearfix">
                                        <div class="pull-right">
                                            <input type="button" class="btn btn-primary" id="button-address-add" value="继续">
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title"><a class="accordion-toggle collapsed" data-parent="#accordion"
                                                       data-toggle="collapse" href="#collapse-shipping-method"
                                                       aria-expanded="false">第 2 步 货运方式 <i class="fa fa-caret-down"></i></a>
                            </h4>
                        </div>
                        <div id="collapse-shipping-method" class="panel-collapse collapse in" aria-expanded="true"
                             style="">
                            <div class="panel-body"><p>请选择一个货运方式。</p>
                                <p><strong>免运费</strong></p>
                                <div class="radio">
                                    <label>
                                        <input type="radio" checked="checked" value="free.free" name="shipping_method">
                                        免运费 - ￥0.00</label>
                                </div>
                                <p><strong>固定运费</strong></p>
                                <div class="radio">
                                    <label>
                                        <input type="radio" value="flat.flat" name="shipping_method">
                                        固定运费 - ￥5.00</label>
                                </div>
                                <p><strong>添加订单备注</strong></p>
                                <p>
                                    <textarea class="form-control" rows="8" name="comment"></textarea>
                                </p>
                                <div class="buttons">
                                    <div class="pull-right">
                                        <input type="button" class="btn btn-primary" data-loading-text="正在加载..."
                                               id="button-shipping-method" value="继续">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title"><a class="accordion-toggle collapsed" data-parent="#accordion"
                                                       data-toggle="collapse" href="#collapse-payment-method"
                                                       aria-expanded="false">第 3 步 支付方式 <i class="fa fa-caret-down"></i></a>
                            </h4>
                        </div>
                        <div id="collapse-payment-method" class="panel-collapse collapse in" aria-expanded="true"
                             style="">
                            <div class="panel-body" ><p id="payment-select" data-url="{:U('paymentList')}">请选择一个支付方式。</p>


                                <p><strong>添加订单备注</strong></p>
                                <p>
                                    <textarea class="form-control" rows="8" name="comment"></textarea>
                                </p>
                                <div class="buttons">
                                    <div class="pull-right">我已经阅读并同意 <a alt="条款及条件"
                                                                        href="http://php.kang.com/test/s/index.php?route=information/information/agree&amp;information_id=5"
                                                                        class="colorbox"><b>条款及条件</b></a> 条款 <input
                                            type="checkbox" value="1" name="agree">
                                        &nbsp;
                                        <input type="button" class="btn btn-primary" data-loading-text="正在加载..."
                                               id="button-payment-method" value="继续">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title"><a class="accordion-toggle" data-parent="#accordion"
                                                       data-toggle="collapse" href="#collapse-checkout-confirm"
                                                       aria-expanded="true">第 4 步 确认订单 <i class="fa fa-caret-down"></i></a>
                            </h4>
                        </div>
                        <div id="collapse-checkout-confirm" class="panel-collapse collapse in" aria-expanded="true"
                             style="">
                            <div class="panel-body">
                                <div class="table-responsive" >
                                    <table class="table table-bordered table-hover" id="table-order">
                                        <thead>
                                        <tr>
                                            <td class="text-left">商品名称</td>
                                            <td class="text-left">型号</td>
                                            <td class="text-right">数量</td>
                                            <td class="text-right">价格</td>
                                            <td class="text-right">合计</td>
                                        </tr>
                                        </thead>
                                        <tbody>


                                        </tbody>
                                        <tfoot>
                                        <tr>
                                            <td class="text-right" colspan="4"><strong>商品总额:</strong></td>
                                            <td class="text-right">￥<span id="order-total-price"></span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-right" colspan="4"><strong>免运费:</strong></td>
                                            <td class="text-right">￥<span id="shipping-fee"></span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-right" colspan="4"><strong>订单总额:</strong></td>
                                            <td class="text-right">￥<span id="order-total-prices"></span></td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="buttons">
                                    <div class="pull-right">
                                        <input type="button" data-loading-text="正在加载..." class="btn btn-primary"
                                               id="button-confirm" value="确认订单"  data-url="{:U('/orderGenerate')}" data-result-url="{:U('/orderResult')}">
                                    </div>
                                </div>
                                <script type="text/javascript"></script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</block>

<block name="appendJs">

    <script>
        function showAddressList()
        {
            var url = $('#select-address_id').data('url');
            var data = {};
            $.get(url, data, function (response) {
                if (0 === response.error) {
                    // 从服务器端获取了数据
                    var html = '';
                    $.each(response.data, function (i, address) {
                        html += '<option ';
                        if ('1' === address.is_default)
                            html += ' selected ';
                        html += 'value="' + address.address_id + '">' +
                                address.name + ', ' + address.telephone + ', ' + address.one_title + ', ' + address.two_title + ', ' + address.three_title + ', ' + address.address + ', ' + address.postcode +
                                '</option>';
                    });
                    $('#select-address_id').append(html);
                    // 并将使用现存地址处于checked状态
                    $('#input-address-existing').prop('checked', true);
                } else {
                    // 没有返回当前会员的地址列表
                    $('#input-address-new').prop('checked', true);
                }
            }, 'json');
        }
    </script>

    <script>
        $(function () {
            showAddressList();
        });
        $(function() {
            $('#button-address-add').click(function(evt) {
                var url = $('#form-address-add').attr('action');
                var data = new FormData(document.getElementById('form-address-add'));
                $.ajax({
                    type: 'post',
                    url: url,
                    data: data,
                    dataType: 'json',
                    processData: false, // 当使用FormData对象, 作为ajax数据时, 不去做数据的转换处理
                    contentType: false, // 当使用FormData对象, 作为ajax数据时, 不去做请求类型的处理
                    success: function(response) {
                        // 在地址列表中, 列出当前的地址
                        showAddressList();
                        // 重置表单
                        document.getElementById('form-address-add').reset();
                    }
                });
                evt.preventDefault();
            });
        })
    </script>

    <script>
        /**
         * 利用上级地区ID, 获取下级地区的全部子地区
         * @param parent_id
         */
        function getRegionList(parent_id, level)
        {
            // 不处理 请选择的情况
            if (parent_id == 0) return;

            var level = level || 1;
            // get请求即可
            var url = $('#container-region-select').data('url');
            var data = {
                parent_id: parent_id,
            };
            $.get(url, data, function(response) {
                // 返回后, 设置列表展示
                if(0 === response.error) {
                    setOptionList(response.data, level);
                }
            }, 'json');
        }

        function setOptionList(optionList, level)
        {
            // 拼凑形成option列表
            var html = '';
            $.each(optionList, function(i, region) {
                html += '<option value="' + region.region_id + '">' + region.title + '</option>';
            });

            // 加入到某个select中:
            // 先删除除了请选择之外的全部的option
            $('select[level=' + level +']>option:gt(0)').remove();
            // 依据当前数据拼凑的option追加
            $('select[level=' + level +']').append(html);

            // 选择省级, 县级处于备选状态
            if (level == 2) {
                $('select[level=3]>option:gt(0)').remove();
            }
        }

    </script>

    <script>
        // 页面加载后触发
        $(function() {
            getRegionList(1, 1);
            // select的change事件触发
            $('select[level=1],select[level=2]').change(function(evt) {
                getRegionList($(this).val(), parseInt($(this).attr('level'))+1);
            });

        });
    </script>
    <script>
        $(function () {
            var url = $('#payment-select').data('url');
            var data = {};
            $.get(url,data,function (response) {
                var html = '';
                if (response.error === 0) {
                    $.each(response.data, function (i, payment) {
                        html += '<div class="radio"><label>' +
                            '<input type="radio" value="' + payment.key + '" name="payment_method" ';
                        if (payment.promoted == '1') html += ' checked ';
                        html += '>' +
                            payment.title +
                            '</label></div>';
                    });
                    $('#payment-select').append(html);
                }
            },'json');
        });
    </script>
    <script>

$(function () {
    var url = $('body').data('cart-info-url');
    data = {
        type : 'checked',
    }
    $.get(url,data,function (response) {
        var html = '';
        if (0===response.error){
            $.each(response.data.goods_list,function (i,order_goods) {
                html += ' <tr>' +
                    '<td class="text-left">' +
                    '<a href="'+order_goods.url+'">'+order_goods.name+'</a>' +
                    '</td>' +
                    '<td class="text-left">'+order_goods.product_title+'</td>' +
                    '<td class="text-right">'+order_goods.quantity+'</td>' +
                    '<td class="text-right">￥'+order_goods.price+'</td>' +
                    '<td class="text-right">'+order_goods.total_price+'</td>' +
                    '</tr>';
            });
            $('#table-order>tbody').append(html);
            $('#order-total-price').html(response.data.total_price);
            if (response.data.total_price > 1000){
                var shipping_fee = 0;
            }else{
                var shipping_fee = 10;
            }
            $('#shipping-fee').html(shipping_fee);
            $('#order-total-prices').html(response.data.total_price + shipping_fee);
        }


    },'json')
});



    </script>
    <script>
        $(function () {
           $('#button-confirm').click(function (evt) {
               var address_id = $('#select-address_id').val();
               if(!address_id){
                   alert('请选择收货地址');
                   return false;
               }
               var shipping_id = $('input[name=shipping_method]:checked').val();
               if(!shipping_id){
                   alert('请选择配送方式');
                   return false;
               }
               var payment_id = $('input[name=payment_method]:checked').val();
               if(!payment_id){
                   alert('请选择支付方式');
                   return false;
               }
               var url = $(this).data('url');
               var data = {
                   address_id : address_id,
                   payment_id:payment_id,
                   shipping_id:shipping_id,
                   comment:$('textarea[name=comment]').val(),
               };
               $.post(url,data,function (response) {
                   location.href = response.data.url;
               },'json');

               evt.preventDefault();
           }) ;
        });
    </script>
</block>